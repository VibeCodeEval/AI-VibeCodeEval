# Middleware vs ê°€ë“œë ˆì¼ ì‹¤í–‰ ìˆœì„œ ë¶„ì„

## ğŸ“‹ ì§ˆë¬¸

1. **ê°€ë“œë ˆì¼ì„ Middleware ì´ì „ì— ì ìš©í•˜ë©´ ì§ì ‘ì ì¸ ì •ë‹µ ìš”ì²­ì„ ì°¨ë‹¨í•  ìˆ˜ ìˆëŠ”ë°, ì´ê²Œ ë¹„íš¨ìœ¨ì ì¸ê°€?**
2. **MiddlewareëŠ” LLMì„ ì•„ì˜ˆ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë¶€ë¶„ì¸ê°€?**

---

## âœ… í•µì‹¬ ë‹µë³€

### 1. ê°€ë“œë ˆì¼ ê²€ì‚¬ë„ LLM í˜¸ì¶œì´ í•„ìš”í•©ë‹ˆë‹¤

**ì¤‘ìš”**: ê°€ë“œë ˆì¼ ê²€ì‚¬ ìì²´ë„ **LLM í˜¸ì¶œ**ì´ í•„ìš”í•©ë‹ˆë‹¤!

```python
# app/domain/langgraph/nodes/intent_analyzer.py

# ê°€ë“œë ˆì¼ ê²€ì‚¬ë¥¼ ìœ„í•œ LLM í˜¸ì¶œ
_base_intent_analysis_chain = (
    RunnableLambda(prepare_input)
    | intent_analysis_prompt      # í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿
    | structured_llm              # â† ì—¬ê¸°ì„œ LLM í˜¸ì¶œ! (ê°€ë“œë ˆì¼ ê²€ì‚¬)
    | RunnableLambda(process_output)
)

# Middlewareê°€ ì´ Chainì„ ë˜í•‘
intent_analysis_chain = wrap_chain_with_middleware(
    _base_intent_analysis_chain,  # ê°€ë“œë ˆì¼ ê²€ì‚¬ í¬í•¨
    name="Intent Analyzer"
)
```

**ê°€ë“œë ˆì¼ ê²€ì‚¬ ê³¼ì •**:
1. ì‚¬ìš©ì ë©”ì‹œì§€ë¥¼ LLMì— ì „ë‹¬
2. LLMì´ í”„ë¡¬í”„íŠ¸ë¥¼ ë¶„ì„í•˜ì—¬ ê°€ë“œë ˆì¼ ìœ„ë°˜ ì—¬ë¶€ íŒë‹¨
3. ê²°ê³¼ ë°˜í™˜ (`PASSED_HINT`, `FAILED_GUARDRAIL` ë“±)

**ê²°ë¡ **: ê°€ë“œë ˆì¼ ê²€ì‚¬ë„ **LLM í˜¸ì¶œì´ í•„ìš”**í•˜ë¯€ë¡œ, Middleware ì—†ì´ ê°€ë“œë ˆì¼ì„ ë¨¼ì € ì ìš©í•˜ë©´ Rate Limit ì—ëŸ¬ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

### 2. MiddlewareëŠ” LLM í˜¸ì¶œ ì „í›„ì˜ ê¸°ìˆ ì  ì²˜ë¦¬

**Middlewareì˜ ì—­í• **:
- âœ… **Rate Limiting**: LLM í˜¸ì¶œ ì „ì— ë¹ˆë„ ì²´í¬ (LLM í˜¸ì¶œ ì—†ìŒ)
- âœ… **Retry**: LLM í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ (LLM í˜¸ì¶œ ìˆìŒ)
- âœ… **Logging**: LLM í˜¸ì¶œ ì „í›„ ë¡œê¹… (LLM í˜¸ì¶œ ì—†ìŒ)

**ì¤‘ìš”**: MiddlewareëŠ” **LLM í˜¸ì¶œì„ ë˜í•‘**í•˜ëŠ” ì—­í• ì…ë‹ˆë‹¤.

```python
# Middleware ë‚´ë¶€ ë™ì‘
async def rate_limited_chain(inputs, config):
    # 1. Rate Limit ì²´í¬ (LLM í˜¸ì¶œ ì—†ìŒ - ë‹¨ìˆœ ì¹´ìš´íŒ…)
    wait_time = await self._check_rate_limit(key)
    if wait_time > 0:
        await asyncio.sleep(wait_time)
    
    # 2. ì‹¤ì œ Chain ì‹¤í–‰ (ì—¬ê¸°ì„œ LLM í˜¸ì¶œ ë°œìƒ)
    return await chain.ainvoke(inputs, config)  # â† ê°€ë“œë ˆì¼ ê²€ì‚¬ LLM í˜¸ì¶œ
```

---

## ğŸ”„ í˜„ì¬ êµ¬ì¡° ë¶„ì„

### í˜„ì¬ ì‹¤í–‰ ìˆœì„œ

```
ì‚¬ìš©ì ìš”ì²­: "ì •ë‹µì„ ì•Œë ¤ì¤˜"
    â†“
[Middleware] Rate Limiting ì²´í¬ (LLM í˜¸ì¶œ ì—†ìŒ)
    â†“
[Middleware] Retry ë¡œì§ ì¤€ë¹„ (LLM í˜¸ì¶œ ì—†ìŒ)
    â†“
[Middleware] Logging ì‹œì‘ (LLM í˜¸ì¶œ ì—†ìŒ)
    â†“
[ê°€ë“œë ˆì¼ ê²€ì‚¬] LLM í˜¸ì¶œ ë°œìƒ! â† ì—¬ê¸°ì„œ ë¹„ìš© ë°œìƒ
    - LLMì´ "ì •ë‹µì„ ì•Œë ¤ì¤˜" ë¶„ì„
    - FAILED_GUARDRAIL ë°˜í™˜
    â†“
[Middleware] Logging ì™„ë£Œ
    â†“
ê²°ê³¼: is_guardrail_failed=True
```

### ê°€ë“œë ˆì¼ì„ ë¨¼ì € ì ìš©í•œë‹¤ë©´?

```
ì‚¬ìš©ì ìš”ì²­: "ì •ë‹µì„ ì•Œë ¤ì¤˜"
    â†“
[ê°€ë“œë ˆì¼ ê²€ì‚¬] LLM í˜¸ì¶œ ë°œìƒ! â† ì—¬ê¸°ì„œ ë¹„ìš© ë°œìƒ
    - Rate Limit ì²´í¬ ì—†ìŒ
    - Rate Limit ì—ëŸ¬ ë°œìƒ ê°€ëŠ¥
    â†“
[Middleware] Rate Limiting ì²´í¬ (ì´ë¯¸ LLM í˜¸ì¶œ í›„)
    â†“
ë¬¸ì œ: Rate Limit ì—ëŸ¬ê°€ LLM í˜¸ì¶œ í›„ ë°œìƒ (ë¹„ìš© ë‚­ë¹„)
```

---

## ğŸ“Š íš¨ìœ¨ì„± ë¹„êµ

### ì‹œë‚˜ë¦¬ì˜¤ 1: Middleware ë¨¼ì € (í˜„ì¬ êµ¬ì¡°) âœ…

**ì¥ì **:
- âœ… Rate Limit ì²´í¬ í›„ LLM í˜¸ì¶œ (ë¹„ìš© ì ˆê°)
- âœ… Rate Limit ì—ëŸ¬ ì‹œ LLM í˜¸ì¶œ ì•ˆ í•¨
- âœ… ì¬ì‹œë„ ë¡œì§ì´ ê°€ë“œë ˆì¼ ê²€ì‚¬ ì „ì— ì ìš©

**ë‹¨ì **:
- âš ï¸ ê°€ë“œë ˆì¼ ìœ„ë°˜ ìš”ì²­ë„ Rate Limit ì²´í¬ í›„ì—ì•¼ ì°¨ë‹¨

**ë¹„ìš©**:
```
Rate Limit ì²´í¬: ë¬´ë£Œ (ì¹´ìš´íŒ…ë§Œ)
ê°€ë“œë ˆì¼ ê²€ì‚¬ LLM í˜¸ì¶œ: 1íšŒ (í•„ìˆ˜)
â†’ ì´ ë¹„ìš©: 1íšŒ LLM í˜¸ì¶œ
```

### ì‹œë‚˜ë¦¬ì˜¤ 2: ê°€ë“œë ˆì¼ ë¨¼ì € âŒ

**ì¥ì **:
- âœ… ê°€ë“œë ˆì¼ ìœ„ë°˜ ìš”ì²­ì„ ì¦‰ì‹œ ì°¨ë‹¨

**ë‹¨ì **:
- âŒ Rate Limit ì²´í¬ ì—†ì´ LLM í˜¸ì¶œ (ë¹„ìš© ë°œìƒ)
- âŒ Rate Limit ì—ëŸ¬ ì‹œ ì´ë¯¸ LLM í˜¸ì¶œ í›„ (ë¹„ìš© ë‚­ë¹„)
- âŒ ì¬ì‹œë„ ë¡œì§ì´ ê°€ë“œë ˆì¼ ê²€ì‚¬ì™€ ë¶„ë¦¬ë¨

**ë¹„ìš©**:
```
ê°€ë“œë ˆì¼ ê²€ì‚¬ LLM í˜¸ì¶œ: 1íšŒ (í•„ìˆ˜)
Rate Limit ì—ëŸ¬ ë°œìƒ ì‹œ: ì´ë¯¸ ë¹„ìš© ë°œìƒ
â†’ ì´ ë¹„ìš©: 1íšŒ LLM í˜¸ì¶œ + ì—ëŸ¬ ì²˜ë¦¬ ë¹„ìš©
```

---

## ğŸ¯ ìµœì  êµ¬ì¡°: í•˜ì´ë¸Œë¦¬ë“œ ì ‘ê·¼

### ê¶Œì¥ êµ¬ì¡°

```
ì‚¬ìš©ì ìš”ì²­
    â†“
[Middleware] Rate Limiting ì²´í¬ (ë¬´ë£Œ)
    â†“
[ê°€ë“œë ˆì¼ ê²€ì‚¬] LLM í˜¸ì¶œ (í•„ìˆ˜)
    - Middlewareë¡œ ë˜í•‘ë¨
    - Rate Limit ì²´í¬ í›„ ì‹¤í–‰
    â†“
[ê²°ê³¼]
    - PASSED: Writer LLM í˜¸ì¶œ
    - FAILED: ì¦‰ì‹œ ì°¨ë‹¨ (Writer LLM í˜¸ì¶œ ì•ˆ í•¨)
```

**í˜„ì¬ êµ¬ì¡°ê°€ ì´ë¯¸ ì´ ë°©ì‹ì…ë‹ˆë‹¤!**

```python
# í˜„ì¬ êµ¬ì¡°
_base_intent_analysis_chain = (
    # ê°€ë“œë ˆì¼ ê²€ì‚¬ (LLM í˜¸ì¶œ í¬í•¨)
    RunnableLambda(prepare_input)
    | intent_analysis_prompt
    | structured_llm  # â† ê°€ë“œë ˆì¼ ê²€ì‚¬ LLM
    | RunnableLambda(process_output)
)

# Middlewareë¡œ ë˜í•‘ (Rate Limit ì²´í¬ í›„ ê°€ë“œë ˆì¼ ê²€ì‚¬)
intent_analysis_chain = wrap_chain_with_middleware(
    _base_intent_analysis_chain,
    name="Intent Analyzer"
)
```

---

## ğŸ’¡ í•µì‹¬ í¬ì¸íŠ¸

### 1. ê°€ë“œë ˆì¼ ê²€ì‚¬ë„ LLM í˜¸ì¶œì´ í•„ìš”

**ì´ìœ **:
- ì‚¬ìš©ì ë©”ì‹œì§€ë¥¼ ë¶„ì„í•˜ì—¬ ê°€ë“œë ˆì¼ ìœ„ë°˜ ì—¬ë¶€ë¥¼ íŒë‹¨
- LLMì´ í”„ë¡¬í”„íŠ¸ë¥¼ ì´í•´í•˜ê³  íŒë‹¨í•´ì•¼ í•¨
- ë‹¨ìˆœ í‚¤ì›Œë“œ ë§¤ì¹­ìœ¼ë¡œëŠ” ë¶€ì •í™•í•¨

**ì˜ˆì‹œ**:
```python
# ì‚¬ìš©ì: "ì •ë‹µì„ ì•Œë ¤ì¤˜" â†’ FAILED_GUARDRAIL
# ì‚¬ìš©ì: "íŒíŠ¸ë¥¼ ì£¼ì„¸ìš”" â†’ PASSED_HINT
# ì‚¬ìš©ì: "ì½”ë“œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”" â†’ PASSED_HINT (AI ì½”ë”© í…ŒìŠ¤íŠ¸ì´ë¯€ë¡œ í—ˆìš©)
```

### 2. MiddlewareëŠ” LLM í˜¸ì¶œì„ ë˜í•‘

**ì—­í• **:
- Rate Limiting: LLM í˜¸ì¶œ ì „ ë¹ˆë„ ì²´í¬ (LLM í˜¸ì¶œ ì—†ìŒ)
- Retry: LLM í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ (LLM í˜¸ì¶œ ìˆìŒ)
- Logging: LLM í˜¸ì¶œ ì „í›„ ë¡œê¹… (LLM í˜¸ì¶œ ì—†ìŒ)

**ì¤‘ìš”**: MiddlewareëŠ” **LLM í˜¸ì¶œ ìì²´ë¥¼ ì œì–´**í•˜ëŠ” ê²ƒì´ì§€, LLMì„ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ê²ƒì´ ì•„ë‹™ë‹ˆë‹¤.

---

## ğŸ” ì‹¤ì œ ì½”ë“œ íë¦„

### Intent Analyzer ì‹¤í–‰ íë¦„

```python
# 1. ì‚¬ìš©ì ìš”ì²­
state = {"human_message": "ì •ë‹µì„ ì•Œë ¤ì¤˜"}

# 2. Middleware ì ìš©ëœ Chain ì‹¤í–‰
result = await intent_analysis_chain.ainvoke({
    "human_message": "ì •ë‹µì„ ì•Œë ¤ì¤˜"
})

# ë‚´ë¶€ ë™ì‘:
#   a. Rate Limiting ì²´í¬ (ë¬´ë£Œ)
#   b. ê°€ë“œë ˆì¼ ê²€ì‚¬ LLM í˜¸ì¶œ (ë¹„ìš© ë°œìƒ)
#      - LLMì´ "ì •ë‹µì„ ì•Œë ¤ì¤˜" ë¶„ì„
#      - FAILED_GUARDRAIL ë°˜í™˜
#   c. ê²°ê³¼ ë°˜í™˜
```

### Writer LLM ì‹¤í–‰ íë¦„

```python
# ê°€ë“œë ˆì¼ ìœ„ë°˜ ì‹œ Writer LLM í˜¸ì¶œ ì•ˆ í•¨
if result["is_guardrail_failed"]:
    # Writer LLM í˜¸ì¶œ ì•ˆ í•¨ (ë¹„ìš© ì ˆê°)
    return {"ai_message": "êµìœ¡ì  í”¼ë“œë°±"}
else:
    # Writer LLM í˜¸ì¶œ (ë¹„ìš© ë°œìƒ)
    ai_message = await writer_chain.ainvoke(state)
```

---

## ğŸ“Š ë¹„ìš© íš¨ìœ¨ì„± ë¶„ì„

### í˜„ì¬ êµ¬ì¡° (Middleware ë¨¼ì €)

| ë‹¨ê³„ | LLM í˜¸ì¶œ | ë¹„ìš© | ì„¤ëª… |
|------|---------|------|------|
| Rate Limit ì²´í¬ | âŒ | ë¬´ë£Œ | ì¹´ìš´íŒ…ë§Œ |
| ê°€ë“œë ˆì¼ ê²€ì‚¬ | âœ… | 1íšŒ | í•„ìˆ˜ (Intent Analyzer) |
| Writer LLM | ì¡°ê±´ë¶€ | 0-1íšŒ | ê°€ë“œë ˆì¼ ìœ„ë°˜ ì‹œ í˜¸ì¶œ ì•ˆ í•¨ |
| **ì´ ë¹„ìš©** | - | **1-2íšŒ** | ìµœì  |

### ê°€ë“œë ˆì¼ ë¨¼ì € êµ¬ì¡°

| ë‹¨ê³„ | LLM í˜¸ì¶œ | ë¹„ìš© | ì„¤ëª… |
|------|---------|------|------|
| ê°€ë“œë ˆì¼ ê²€ì‚¬ | âœ… | 1íšŒ | í•„ìˆ˜ |
| Rate Limit ì²´í¬ | âŒ | ë¬´ë£Œ | ì´ë¯¸ LLM í˜¸ì¶œ í›„ |
| Writer LLM | ì¡°ê±´ë¶€ | 0-1íšŒ | ê°€ë“œë ˆì¼ ìœ„ë°˜ ì‹œ í˜¸ì¶œ ì•ˆ í•¨ |
| **ì´ ë¹„ìš©** | - | **1-2íšŒ** | ë™ì¼í•˜ì§€ë§Œ Rate Limit ì—ëŸ¬ ì‹œ ë¹„ìš© ë‚­ë¹„ |

---

## âœ… ê²°ë¡ 

### 1. ê°€ë“œë ˆì¼ì„ ë¨¼ì € ì ìš©í•˜ëŠ” ê²ƒì´ ë¹„íš¨ìœ¨ì ì¸ê°€?

**ë‹µë³€**: **ë„¤, ì•½ê°„ ë¹„íš¨ìœ¨ì ì…ë‹ˆë‹¤.**

**ì´ìœ **:
- ê°€ë“œë ˆì¼ ê²€ì‚¬ë„ LLM í˜¸ì¶œì´ í•„ìš”
- Rate Limit ì²´í¬ ì—†ì´ LLM í˜¸ì¶œ ì‹œ ì—ëŸ¬ ë°œìƒ ê°€ëŠ¥
- ì—ëŸ¬ ë°œìƒ ì‹œ ì´ë¯¸ ë¹„ìš© ë°œìƒ (ë‚­ë¹„)

### 2. MiddlewareëŠ” LLMì„ ì•„ì˜ˆ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë¶€ë¶„ì¸ê°€?

**ë‹µë³€**: **ì•„ë‹ˆìš”, LLM í˜¸ì¶œì„ ë˜í•‘í•˜ëŠ” ë¶€ë¶„ì…ë‹ˆë‹¤.**

**ì—­í• **:
- Rate Limiting: LLM í˜¸ì¶œ ì „ ë¹ˆë„ ì²´í¬ (LLM í˜¸ì¶œ ì—†ìŒ)
- Retry: LLM í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ (LLM í˜¸ì¶œ ìˆìŒ)
- Logging: LLM í˜¸ì¶œ ì „í›„ ë¡œê¹… (LLM í˜¸ì¶œ ì—†ìŒ)

### 3. ìµœì  êµ¬ì¡°

**í˜„ì¬ êµ¬ì¡°ê°€ ì´ë¯¸ ìµœì ì…ë‹ˆë‹¤!**

```
Middleware (Rate Limit ì²´í¬) 
    â†“
ê°€ë“œë ˆì¼ ê²€ì‚¬ (LLM í˜¸ì¶œ)
    â†“
ê²°ê³¼ì— ë”°ë¼ Writer LLM í˜¸ì¶œ ì—¬ë¶€ ê²°ì •
```

**ì¥ì **:
- âœ… Rate Limit ì²´í¬ í›„ LLM í˜¸ì¶œ (ë¹„ìš© ì ˆê°)
- âœ… ê°€ë“œë ˆì¼ ìœ„ë°˜ ì‹œ Writer LLM í˜¸ì¶œ ì•ˆ í•¨ (ë¹„ìš© ì ˆê°)
- âœ… ì¬ì‹œë„ ë¡œì§ì´ ê°€ë“œë ˆì¼ ê²€ì‚¬ ì „ì— ì ìš© (ì•ˆì •ì„±)

---

## ğŸ¯ ê¶Œì¥ ì‚¬í•­

### í˜„ì¬ êµ¬ì¡° ìœ ì§€ âœ…

**ì´ìœ **:
1. **ë¹„ìš© íš¨ìœ¨ì„±**: Rate Limit ì²´í¬ í›„ LLM í˜¸ì¶œ
2. **ì•ˆì •ì„±**: ì¬ì‹œë„ ë¡œì§ì´ ê°€ë“œë ˆì¼ ê²€ì‚¬ ì „ì— ì ìš©
3. **ì¼ê´€ì„±**: ëª¨ë“  ë…¸ë“œì—ì„œ ë™ì¼í•œ Middleware ì ìš©

### ê°œì„  ê°€ëŠ¥í•œ ë¶€ë¶„

ë§Œì•½ ê°€ë“œë ˆì¼ ìœ„ë°˜ ìš”ì²­ì„ ë” ë¹ ë¥´ê²Œ ì°¨ë‹¨í•˜ê³  ì‹¶ë‹¤ë©´:

```python
# ì˜µì…˜: ê°„ë‹¨í•œ í‚¤ì›Œë“œ í•„í„°ë§ ì¶”ê°€ (LLM í˜¸ì¶œ ì „)
def quick_guardrail_check(message: str) -> bool:
    """ê°„ë‹¨í•œ í‚¤ì›Œë“œ ê¸°ë°˜ ì‚¬ì „ í•„í„°ë§"""
    blocked_keywords = ["ì •ë‹µ", "ë‹µ", "answer", "solution"]
    return any(keyword in message.lower() for keyword in blocked_keywords)

# ì‚¬ìš©
if quick_guardrail_check(human_message):
    return {"is_guardrail_failed": True}  # LLM í˜¸ì¶œ ì—†ì´ ì¦‰ì‹œ ì°¨ë‹¨
```

**í•˜ì§€ë§Œ**: ì´ëŠ” ì •í™•ë„ê°€ ë‚®ìœ¼ë¯€ë¡œ, í˜„ì¬ LLM ê¸°ë°˜ ê²€ì‚¬ê°€ ë” ì •í™•í•©ë‹ˆë‹¤.

---

## ğŸ“ ìš”ì•½

1. **ê°€ë“œë ˆì¼ ê²€ì‚¬ë„ LLM í˜¸ì¶œì´ í•„ìš”**í•©ë‹ˆë‹¤
2. **MiddlewareëŠ” LLM í˜¸ì¶œì„ ë˜í•‘**í•˜ëŠ” ì—­í• ì…ë‹ˆë‹¤
3. **í˜„ì¬ êµ¬ì¡°ê°€ ì´ë¯¸ ìµœì **ì…ë‹ˆë‹¤ (Middleware â†’ ê°€ë“œë ˆì¼ ê²€ì‚¬)
4. **ê°€ë“œë ˆì¼ì„ ë¨¼ì € ì ìš©í•˜ë©´ ì•½ê°„ ë¹„íš¨ìœ¨ì **ì…ë‹ˆë‹¤ (Rate Limit ì—ëŸ¬ ì‹œ ë¹„ìš© ë‚­ë¹„)




