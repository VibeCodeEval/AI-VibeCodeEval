{
  "command_id": "CMD_004",
  "timestamp": "2026-01-21T00:00:00Z",
  "from": "maestro",
  "to": "sub_agent_finetuning_chaining",
  "priority": "high",
  "phase": "phase5c",
  "title": "Chaining 전략 평가 파인튜닝 데이터 추출",
  "status": "pending",
  "description": "PostgreSQL DB의 prompt_evaluations 테이블에서 HOLISTIC_FLOW 유형의 Chaining 전략 평가 데이터를 추출합니다. 이 데이터는 6a 노드(전체 플로우 평가)에서 생성되며, 사용자의 문제 분해, 피드백 수용성, 전략적 탐색 능력을 평가한 결과입니다.",
  "prerequisites": [
    "Phase 3 완료: AI 생성 코드 점검",
    "PostgreSQL DB 접근 가능"
  ],
  "approach": "DB 쿼리 및 JSONB 데이터 파싱",
  
  "db_schema": {
    "table": "prompt_evaluations",
    "filter": "evaluation_type = 'HOLISTIC_FLOW' AND turn IS NULL",
    "details_structure": {
      "score": "float - 전체 Chaining 점수",
      "analysis": "str - 종합 분석 내용",
      "problem_decomposition": {
        "score": "float - 문제 분해 점수",
        "analysis": "str - 문제 분해 분석"
      },
      "feedback_integration": {
        "score": "float - 피드백 수용성 점수",
        "analysis": "str - 피드백 수용성 분석"
      },
      "strategic_exploration": {
        "score": "float - 전략적 탐색 점수",
        "analysis": "str - 전략적 탐색 분석"
      },
      "structured_logs": [
        {
          "turn": "int - 턴 번호",
          "intent": "str - 의도 분류",
          "user_prompt_summary": "str - 사용자 프롬프트 요약",
          "ai_summary": "str - AI 응답 요약",
          "turn_score": "float - 턴 점수"
        }
      ]
    }
  },
  
  "tasks": [
    {
      "step": 1,
      "name": "데이터 추출 스크립트 개발",
      "description": "prompt_evaluations 테이블에서 HOLISTIC_FLOW 평가 데이터를 추출하는 Python 스크립트 개발",
      "sql_query": "SELECT\n    pe.id,\n    pe.session_id,\n    pe.evaluation_type,\n    pe.details,\n    pe.created_at,\n    ps.problem_spec_id\nFROM prompt_evaluations pe\nLEFT JOIN prompt_sessions ps ON pe.session_id = ps.id\nWHERE pe.evaluation_type::text = 'HOLISTIC_FLOW'\n    AND pe.turn IS NULL\n    AND pe.details->>'score' IS NOT NULL\nORDER BY pe.session_id;",
      "details": [
        "evaluation_type가 'HOLISTIC_FLOW'인 레코드만 추출",
        "turn이 NULL인 레코드 확인 (세션 전체 평가)",
        "details JSONB에서 score, analysis, 각 평가 항목 파싱",
        "structured_logs에서 턴별 요약 정보 추출"
      ],
      "output_script": "scripts/extract_chaining_finetuning_data.py"
    },
    {
      "step": 2,
      "name": "데이터 형식 정의 및 저장",
      "description": "추출된 데이터를 JSONL 형식으로 저장",
      "schema": {
        "id": "string - 고유 식별자 (예: chaining_session_4)",
        "session_id": "int - 세션 ID",
        "total_score": "float - 전체 Chaining 점수",
        "analysis": "str - 종합 분석 내용",
        "evaluation_criteria": {
          "problem_decomposition": {
            "score": "float",
            "analysis": "str"
          },
          "feedback_integration": {
            "score": "float",
            "analysis": "str"
          },
          "strategic_exploration": {
            "score": "float",
            "analysis": "str"
          }
        },
        "turn_summaries": [
          {
            "turn": "int",
            "intent": "str",
            "user_summary": "str",
            "ai_summary": "str",
            "score": "float"
          }
        ],
        "turn_count": "int - 총 턴 수",
        "metadata": {
          "problem_spec_id": "int (optional)",
          "created_at": "str"
        }
      },
      "output_files": [
        ".maestro/data/finetuning/chaining_data.jsonl",
        ".maestro/data/finetuning/chaining_high_score.jsonl",
        ".maestro/data/finetuning/chaining_medium_score.jsonl",
        ".maestro/data/finetuning/chaining_low_score.jsonl",
        ".maestro/data/finetuning/chaining_examples.json"
      ]
    },
    {
      "step": 3,
      "name": "데이터 검증 및 통계",
      "description": "추출된 데이터의 유효성을 검증하고 통계를 생성",
      "checklist": [
        "데이터 누락 여부 확인",
        "각 평가 항목(problem_decomposition, feedback_integration, strategic_exploration)의 존재 여부 확인",
        "점수 분포 통계 생성 (전체 점수, 항목별 점수)",
        "턴 수 분포 확인 (짧은 세션 vs 긴 세션)"
      ],
      "output_report": ".maestro/reports/chaining_finetuning_data_report.md"
    },
    {
      "step": 4,
      "name": "Few-shot 예시 선정",
      "description": "Chaining 평가 파인튜닝을 위한 대표 예시 선정",
      "criteria": [
        "고점 (70+): 우수한 Chaining 전략 예시 3-5개",
        "중점 (40-69): 보통 Chaining 전략 예시 3-5개",
        "저점 (0-39): 개선 필요 Chaining 전략 예시 3-5개",
        "각 평가 항목별 우수/미흡 사례 선정"
      ],
      "output_file": ".maestro/data/finetuning/chaining_examples.json"
    }
  ],
  
  "code_reference": {
    "db_save_location": "app/domain/langgraph/nodes/holistic_evaluator/flow.py:389-430",
    "storage_service": "app/application/services/evaluation_storage_service.py:200-277",
    "evaluation_criteria": [
      "문제 분해 (Problem Decomposition) - 복잡한 문제를 작은 단위로 분해하는 능력",
      "피드백 수용성 (Feedback Integration) - AI 피드백을 수용하고 개선하는 능력",
      "전략적 탐색 (Strategic Exploration) - 다양한 접근법을 시도하는 능력"
    ]
  },
  
  "deliverables": [
    "scripts/extract_chaining_finetuning_data.py",
    ".maestro/data/finetuning/chaining_data.jsonl",
    ".maestro/data/finetuning/chaining_high_score.jsonl",
    ".maestro/data/finetuning/chaining_medium_score.jsonl",
    ".maestro/data/finetuning/chaining_low_score.jsonl",
    ".maestro/data/finetuning/chaining_examples.json",
    ".maestro/reports/chaining_finetuning_data_report.md"
  ],
  
  "acceptance_criteria": [
    "HOLISTIC_FLOW 평가 데이터가 정확하게 추출됨",
    "3개 평가 항목(problem_decomposition, feedback_integration, strategic_exploration)이 모두 포함됨",
    "structured_logs에서 턴별 요약 정보가 정확히 파싱됨",
    "점수대별 분류 완료",
    "Few-shot 예시 선정 완료"
  ],
  
  "notes": "이 데이터셋은 6a 노드(Holistic Flow Evaluator)의 Chaining 전략 평가 품질을 개선하기 위한 파인튜닝에 사용됩니다. TURN_EVAL과 달리 세션 전체를 평가하므로 turn이 NULL입니다."
}
